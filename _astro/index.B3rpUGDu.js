let N=(e,f,t,T)=>(e.events=e.events||{},e.events[t+10]||(e.events[t+10]=T(i=>{e.events[t].reduceRight((n,l)=>(l(n),n),{shared:{},...i})})),e.events[t]=e.events[t]||[],e.events[t].push(f),()=>{let i=e.events[t],n=i.indexOf(f);i.splice(n,1),i.length||(delete e.events[t],e.events[t+10](),delete e.events[t+10])}),u=(e,f)=>N(e,f,2,t=>{let T=e.set,i=e.setKey;return e.setKey&&(e.setKey=(n,l)=>{let s;if(t({abort:()=>{s=!0},changed:n,newValue:{...e.value,[n]:l}}),!s)return i(n,l)}),e.set=n=>{let l;if(t({abort:()=>{l=!0},newValue:n}),!l)return T(n)},()=>{e.set=T,e.setKey=i}}),U=1e3,E=(e,f)=>N(e,T=>{let i=f(T);i&&e.events[6].push(i)},5,T=>{let i=e.listen;e.listen=(...l)=>(!e.lc&&!e.active&&(e.active=!0,T()),i(...l));let n=e.off;return e.events[6]=[],e.off=()=>{n(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let l of e.events[6])l();e.events[6]=[]}},U)},()=>{e.listen=i,e.off=n}});export{u as a,E as o};
